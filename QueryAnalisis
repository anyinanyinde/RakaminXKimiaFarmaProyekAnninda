     WITH finaltrans AS (
    SELECT 
        transaction_id,
        date,
        branch_id,
        customer_name,
        product_id,
        price AS transaction_price,
        discount_percentage,
        rating AS transaction_rating,
        price * (1- discount_percentage) AS net_sales
    FROM `kimia_farma.kf_final_transaction`
),

cabang AS (
    SELECT 
        branch_id,
        branch_name,
        kota,
        provinsi,
        rating AS branch_rating
    FROM `kimia_farma.kf_kantor_cabang`
),

product AS (
    SELECT 
        product_id,
        product_name,
        product_category,
        price AS actual_price
    FROM `kimia_farma.kf_product`
),

inventory AS (
    SELECT 
        inventory_id,
        branch_id,
        product_id,
        product_name AS inventory_product_name,
        opname_stock
    FROM `kimia_farma.kf_inventory`
), 
gabung AS (
SELECT 
    t.transaction_id,
    t.date,
    b.branch_id,
    b.branch_name,
    b.kota,
    b.provinsi,
    b.branch_rating,
    t.customer_name,
    p.product_id,
    p.product_name,
    p.actual_price,
    t.discount_percentage,
    ( ((p.actual_price - t.net_sales) )
       / (t.transaction_price * (1 - t.discount_percentage)) ) * 100 AS gross_profit_percent,
    t.net_sales,
    (p.actual_price - t.net_sales) AS net_profit,
    t.transaction_rating,
    i.opname_stock
FROM finaltrans t
JOIN cabang b ON t.branch_id = b.branch_id
JOIN product p ON t.product_id = p.product_id
LEFT JOIN inventory i 
    ON t.branch_id = i.branch_id 
   AND t.product_id = i.product_id
   
)
 SELECT DISTINCT * FROM gabung
